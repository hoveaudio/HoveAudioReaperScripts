-- Duplicate Selected MIDI Notes in Place
-- This script duplicates all selected MIDI notes at their exact same positions

function main()
    -- Get the active MIDI editor
    local hwnd = reaper.MIDIEditor_GetActive()
    if not hwnd then
        reaper.ShowMessageBox("No active MIDI editor found", "Error", 0)
        return
    end
    
    -- Get the MIDI take from the active editor
    local take = reaper.MIDIEditor_GetTake(hwnd)
    if not take then
        reaper.ShowMessageBox("No MIDI take found", "Error", 0)
        return
    end
    
    -- Begin undo block
    reaper.Undo_BeginBlock()
    
    -- Get the number of notes in the take
    local _, notecount = reaper.MIDI_CountEvts(take)
    
    local notes_to_duplicate = {}
    
    -- Collect all selected notes
    for i = 0, notecount - 1 do
        local retval, selected, muted, startppq, endppq, chan, pitch, vel = reaper.MIDI_GetNote(take, i)
        if retval and selected then
            table.insert(notes_to_duplicate, {
                startppq = startppq,
                endppq = endppq,
                chan = chan,
                pitch = pitch,
                vel = vel,
                muted = muted
            })
        end
    end
    
    -- Insert duplicated notes
    for _, note in ipairs(notes_to_duplicate) do
        reaper.MIDI_InsertNote(take, false, note.muted, note.startppq, note.endppq, note.chan, note.pitch, note.vel, true)
    end
    
    -- Sort the MIDI take to ensure proper ordering
    reaper.MIDI_Sort(take)
    
    -- End undo block
    reaper.Undo_EndBlock("Duplicate MIDI Notes in Place", -1)
    
    -- Update the MIDI editor display
    reaper.UpdateArrange()
end

-- Run the main function
main()
